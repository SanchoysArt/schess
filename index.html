ю<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Шахматы • Stable Fullscreen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui,sans-serif;
  height:100dvh;
  display:flex;
  flex-direction:column;
}

#controls{
  padding:8px;
  display:flex;
  gap:8px;
  justify-content:center;
  background:#100;
  flex-shrink:0;
}

select,button{
  background:#200;
  color:#fff;
  border:1px solid #600;
  border-radius:8px;
  padding:6px 10px;
  font-size:16px;
}

#status{
  text-align:center;
  padding:6px;
  font-size:18px;
  flex-shrink:0;
}

#game{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
}

#board{
  width:100%;
  max-width:600px;
  aspect-ratio:1 / 1;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  box-shadow:0 0 30px rgba(255,0,0,.6);
  border-radius:14px;
  overflow:hidden;
}

.square{
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:clamp(26px,8vw,64px);
  position:relative;
}

.light{background:#2a0000}
.dark{background:#140000}

.square.highlight::after{
  content:"";
  position:absolute;
  inset:18%;
  border-radius:50%;
  background:radial-gradient(circle,rgba(255,0,0,.7),transparent 70%);
}

.piece{
  width:80%;
  height:80%;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(145deg,#444,#111);
  box-shadow:
    0 6px 16px rgba(0,0,0,.8),
    inset 0 0 8px rgba(255,255,255,.25),
    0 0 12px rgba(255,0,0,.6);
}
</style>
</head>

<body>

<div id="controls">
  <select id="level">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3" selected>3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <select id="side">
    <option value="w">Белые</option>
    <option value="b">Чёрные</option>
  </select>

  <button onclick="newGame()">Новая игра</button>
</div>

<div id="status"></div>

<div id="game">
  <div id="board"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.wasm.js"></script>

<script>
const game = new Chess()
const boardEl = document.getElementById("board")
const statusEl = document.getElementById("status")

const symbols = {
  p:"♟",r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",
  P:"♙",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔"
}

let selected = null
let userSide = "w"

const engine = new Worker(
  "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.wasm.js"
)

engine.postMessage("uci")

engine.onmessage = e => {
  if (e.data.startsWith("bestmove")) {
    const m = e.data.split(" ")[1]
    if (m && m !== "(none)") {
      game.move({ from:m.slice(0,2), to:m.slice(2,4), promotion:"q" })
      updateStatus()
      draw()
    }
  }
}

function draw(){
  boardEl.innerHTML=""
  const b = game.board()
  const flip = userSide === "b"

  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const rr = flip ? 7-r : r
      const cc = flip ? 7-c : c
      const sq = document.createElement("div")
      sq.className = "square " + ((rr+cc)%2 ? "dark":"light")
      const pos = "abcdefgh"[cc] + (8-rr)
      sq.dataset.pos = pos

      if(selected){
        const moves = game.moves({square:selected,verbose:true})
        if(moves.some(m=>m.to===pos)) sq.classList.add("highlight")
      }

      sq.onclick = () => click(pos)

      const p = b[rr][cc]
      if(p){
        const pe = document.createElement("div")
        pe.className="piece"
        pe.textContent = symbols[p.color==="w"?p.type.toUpperCase():p.type]
        sq.appendChild(pe)
      }

      boardEl.appendChild(sq)
    }
  }
}

function click(pos){
  if(game.game_over()) return
  if(game.turn() !== userSide) return

  if(selected){
    const m = game.move({from:selected,to:pos,promotion:"q"})
    selected = null
    if(m){
      updateStatus()
      draw()
      setTimeout(aiMove,300)
    } else {
      selected = pos
      draw()
    }
  } else {
    const p = game.get(pos)
    if(p && p.color === userSide){
      selected = pos
      draw()
    }
  }
}

function aiMove(){
  if(game.game_over()) return
  engine.postMessage("position fen " + game.fen())
  engine.postMessage(
    "go depth " + (Number(level.value)*3 + 2)
  )
}

function updateStatus(){
  if(game.in_checkmate())
    statusEl.textContent =
      game.turn() === userSide ? "Вы проиграли" : "Вы победили"
  else if(game.in_draw())
    statusEl.textContent = "Ничья"
  else
    statusEl.textContent =
      game.turn() === userSide ? "Ваш ход" : "Ход ИИ"
}

function newGame(){
  game.reset()
  engine.postMessage("ucinewgame")
  userSide = side.value
  selected = null
  statusEl.textContent = ""
  draw()
  if(userSide === "b") setTimeout(aiMove,400)
}

newGame()
</script>
</body>
</html>