<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —à–∞—Ö–º–∞—Ç—ã</title>

<!-- –®–ê–•–ú–ê–¢–ù–ê–Ø –õ–û–ì–ò–ö–ê (–í–°–ï –ü–†–ê–í–ò–õ–ê) -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>

<!-- –†–ï–ê–õ–¨–ù–´–ô –ò–ò -->
<script src="https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.js"></script>

<style>
/* ================== –û–ë–©–ï–ï ================== */
* { box-sizing: border-box; }

body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

#app{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

/* ================== –î–û–°–ö–ê ================== */
#board{
  display:grid;
  grid-template-columns:repeat(8,64px);
  grid-template-rows:repeat(8,64px);
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 0 40px rgba(255,255,255,.15);
}

.cell{
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:36px;
  cursor:pointer;
}

.light{ background:#eee; color:#000; }
.dark { background:#222; }

.cell.highlight{
  box-shadow:inset 0 0 0 4px rgba(0,255,255,.6);
}

/* ================== –ü–ê–ù–ï–õ–¨ ================== */
#panel{
  width:260px;
}

select,button{
  width:100%;
  padding:10px;
  margin-bottom:8px;
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:8px;
}

#status{
  min-height:28px;
  text-align:center;
  margin-top:6px;
}

#comment{
  min-height:32px;
  text-align:center;
  font-weight:600;
}

/* –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
.good{ color:#7CFC00; }
.ok{ color:#ccc; }
.bad{ color:#ff9f43; }
.blunder{ color:#ff4d4d; }
.mate{ color:#ff3b3b; }
</style>
</head>

<body>

<div id="app">

  <div id="board"></div>

  <div id="panel">
    <select id="side">
      <option value="w">–ë–µ–ª—ã–µ</option>
      <option value="b">–ß—ë—Ä–Ω—ã–µ</option>
    </select>

    <select id="level">
      <option value="4">–û—á–µ–Ω—å –ª–µ–≥–∫–æ</option>
      <option value="6">–õ–µ–≥–∫–æ</option>
      <option value="8" selected>–ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
      <option value="12">–°–ª–æ–∂–Ω–æ</option>
      <option value="15">–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ</option>
    </select>

    <button onclick="newGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>

    <div id="status"></div>
    <div id="comment"></div>
  </div>

</div>

<script>
/* =========================================================
   –ê–£–î–ò–û (Web Audio)
   ========================================================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

function beep(freq,dur=0.1,vol=0.15){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value=freq;
  g.gain.value=vol;
  o.start();
  o.stop(audioCtx.currentTime+dur);
}

const soundMove   =()=>beep(600,0.08,0.12);
const soundCap    =()=>beep(400,0.12,0.18);
const soundCheck  =()=>beep(180,0.25,0.25);
const soundMate   =()=>{beep(200,0.4,0.3);setTimeout(()=>beep(120,0.5,0.35),200);};

/* =========================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
   ========================================================= */
const game = new Chess();
const engine = Stockfish();

const PIECES = {
  p:'‚ôü', r:'‚ôú', n:'‚ôû', b:'‚ôù', q:'‚ôõ', k:'‚ôö',
  P:'‚ôô', R:'‚ôñ', N:'‚ôò', B:'‚ôó', Q:'‚ôï', K:'‚ôî'
};

let selected=null;
let playerSide='w';
let evalBefore=0;

/* =========================================================
   –î–û–°–ö–ê
   ========================================================= */
const boardEl=document.getElementById("board");

function drawBoard(){
  boardEl.innerHTML="";
  const b=game.board();

  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const cell=document.createElement("div");
      cell.className="cell "+((r+c)%2?"dark":"light");
      const p=b[r][c];
      if(p){
        cell.textContent=PIECES[p.color==='w'?p.type.toUpperCase():p.type];
      }
      cell.onclick=()=>onCellClick(r,c);
      boardEl.appendChild(cell);
    }
  }
}

/* =========================================================
   STOCKFISH
   ========================================================= */
engine.onmessage=e=>{
  const line=e.data;

  if(line.includes("score cp")){
    const cp=parseInt(line.split("score cp")[1]);
    evalBefore=cp/100;
  }

  if(line.startsWith("bestmove")){
    const m=line.split(" ")[1];
    const move=game.move({from:m.slice(0,2),to:m.slice(2,4),promotion:'q'});
    drawBoard();
    playSound(move);
    updateStatus();
  }
};

/* =========================================================
   –•–û–î–´
   ========================================================= */
function onCellClick(r,c){
  if(game.turn()!==playerSide) return;

  const sq="abcdefgh"[c]+(8-r);

  if(selected){
    evaluate(()=>{
      const move=game.move({from:selected,to:sq,promotion:'q'});
      selected=null;
      drawBoard();
      if(move){
        playSound(move);
        evaluate(()=>{
          commentMove(evalBefore);
          updateStatus();
          setTimeout(aiMove,300);
        });
      }
    });
    return;
  }

  const p=game.get(sq);
  if(p&&p.color===playerSide) selected=sq;
}

function aiMove(){
  engine.postMessage("position fen "+game.fen());
  engine.postMessage("go depth "+level.value);
}

/* =========================================================
   –û–¶–ï–ù–ö–ê –ò –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò
   ========================================================= */
function evaluate(cb){
  engine.postMessage("position fen "+game.fen());
  engine.postMessage("go depth 6");
  setTimeout(cb,200);
}

function commentMove(after){
  const diff=after-evalBefore;
  let text="",cls="";
  if(diff<-3){text="‚ùå –ó–µ–≤–æ–∫";cls="blunder";}
  else if(diff<-1){text="‚ö†Ô∏è –ù–µ—Ç–æ—á–Ω—ã–π —Ö–æ–¥";cls="bad";}
  else if(diff<1){text="üëç –•–æ—Ä–æ—à–∏–π —Ö–æ–¥";cls="ok";}
  else if(diff<3){text="‚ú® –û—Ç–ª–∏—á–Ω—ã–π —Ö–æ–¥";cls="good";}
  else{text="üî• –ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–π —Ö–æ–¥";cls="good";}
  comment.textContent=text;
  comment.className=cls;
}

/* =========================================================
   –°–¢–ê–¢–£–° –ò –ó–í–£–ö
   ========================================================= */
function playSound(move){
  if(!move) return;
  if(move.flags.includes('c')||move.flags.includes('e')) soundCap();
  else soundMove();

  if(game.in_checkmate()) soundMate();
  else if(game.in_check()) soundCheck();
}

function updateStatus(){
  if(game.in_checkmate()){
    status.textContent="üëë –ú–∞—Ç";
    comment.textContent="–ü–∞—Ä—Ç–∏—è –æ–∫–æ–Ω—á–µ–Ω–∞";
    comment.className="mate";
  }else if(game.in_check()){
    status.textContent="‚ö†Ô∏è –®–∞—Ö";
  }else{
    status.textContent="";
  }
}

/* =========================================================
   –ù–û–í–ê–Ø –ò–ì–†–ê
   ========================================================= */
function newGame(){
  game.reset();
  playerSide=side.value;
  comment.textContent="";
  drawBoard();
  updateStatus();
  if(playerSide==='b') setTimeout(aiMove,300);
}

/* =========================================================
   –°–¢–ê–†–¢
   ========================================================= */
newGame();
</script>

</body>
</html>