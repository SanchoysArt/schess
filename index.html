<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —à–∞—Ö–º–∞—Ç—ã</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard.min.css">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: #121212;
  color: #fff;
  font-family: system-ui;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#menu, #game {
  background: #1f1f1f;
  padding: 20px;
  border-radius: 14px;
  width: 100%;
  max-width: 460px;
  box-shadow: 0 0 25px black;
}

h1 { text-align: center; margin-top: 0; }

select, button {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
}

button {
  background: #4caf50;
  color: white;
  cursor: pointer;
}

#game { display: none; }

#top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

#comment {
  font-size: 14px;
  opacity: 0.9;
}

#board-wrapper {
  width: 100%;
  aspect-ratio: 1 / 1;
}

#board { width: 100%; }

#controls {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

#controls button {
  flex: 1;
  background: #333;
}
</style>
</head>

<body>

<!-- ===== –ú–ï–ù–Æ ===== -->
<div id="menu">
  <h1>‚ôü –®–∞—Ö–º–∞—Ç—ã</h1>

  <label>–¶–≤–µ—Ç —Ñ–∏–≥—É—Ä</label>
  <select id="color">
    <option value="white">–ë–µ–ª—ã–µ</option>
    <option value="black">–ß—ë—Ä–Ω—ã–µ</option>
  </select>

  <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò</label>
  <select id="level">
    <option value="2">–û—á–µ–Ω—å –ª–µ–≥–∫–æ</option>
    <option value="5">–õ–µ–≥–∫–æ</option>
    <option value="8">–°—Ä–µ–¥–Ω–µ</option>
    <option value="12">–°–ª–æ–∂–Ω–æ</option>
    <option value="18">–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ</option>
  </select>

  <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<!-- ===== –ò–ì–†–ê ===== -->
<div id="game">
  <div id="top-bar">
    <div id="status">–í–∞—à —Ö–æ–¥</div>
    <div id="comment"></div>
  </div>

  <div id="board-wrapper">
    <div id="board"></div>
  </div>

  <div id="controls">
    <button onclick="undoMove()">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å</button>
    <button onclick="resign()">üè≥ –°–¥–∞—Ç—å—Å—è</button>
    <button onclick="restart()">‚Üª –ó–∞–Ω–æ–≤–æ</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard.min.js"></script>

<script>
let board, game, engine;
let playerColor, aiDepth;

const comments = [
  "–ó–µ–≤–æ–∫",
  "–ù–µ—Ç–æ—á–Ω—ã–π —Ö–æ–¥",
  "–•–æ—Ä–æ—à–∏–π —Ö–æ–¥",
  "–û—Ç–ª–∏—á–Ω—ã–π —Ö–æ–¥",
  "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–π —Ö–æ–¥"
];

function startGame() {
  playerColor = document.getElementById("color").value;
  aiDepth = document.getElementById("level").value;

  document.getElementById("menu").style.display = "none";
  document.getElementById("game").style.display = "block";

  game = new Chess();

  board = Chessboard("board", {
    draggable: true,
    position: "start",
    orientation: playerColor,
    onDragStart,
    onDrop,
    onMouseoverSquare,
    onMouseoutSquare
  });

  engine = new Worker("https://cdn.jsdelivr.net/npm/stockfish/stockfish.js");
  engine.postMessage("uci");

  if (playerColor === "black") {
    setTimeout(makeAIMove, 500);
  }
}

function onDragStart(source, piece) {
  if (game.game_over()) return false;
  if (game.turn() === "w" && piece.startsWith("b")) return false;
  if (game.turn() === "b" && piece.startsWith("w")) return false;
}

function onDrop(source, target) {
  const move = game.move({
    from: source,
    to: target,
    promotion: "q"
  });

  if (move === null) return "snapback";

  commentMove();
  updateStatus();
  setTimeout(makeAIMove, 300);
}

function makeAIMove() {
  engine.postMessage("position fen " + game.fen());
  engine.postMessage("go depth " + aiDepth);

  engine.onmessage = e => {
    if (e.data.startsWith("bestmove")) {
      const m = e.data.split(" ")[1];
      game.move({
        from: m.substring(0, 2),
        to: m.substring(2, 4),
        promotion: "q"
      });
      board.position(game.fen());
      updateStatus();
    }
  };
}

function updateStatus() {
  const status = document.getElementById("status");

  if (game.in_checkmate()) status.textContent = "–ú–∞—Ç";
  else if (game.in_draw()) status.textContent = "–ù–∏—á—å—è";
  else if (game.in_check()) status.textContent = "–®–∞—Ö";
  else status.textContent = game.turn() === "w" ? "–í–∞—à —Ö–æ–¥" : "–•–æ–¥ –ò–ò";
}

function undoMove() {
  game.undo();
  game.undo();
  board.position(game.fen());
}

function resign() {
  alert("–í—ã —Å–¥–∞–ª–∏—Å—å");
  restart();
}

function restart() {
  location.reload();
}

function commentMove() {
  document.getElementById("comment").textContent =
    comments[Math.floor(Math.random() * comments.length)];
}

/* ===== –ü–û–î–°–í–ï–¢–ö–ê –•–û–î–û–í ===== */
function onMouseoverSquare(square) {
  const moves = game.moves({ square, verbose: true });
  moves.forEach(m => {
    const el = document.querySelector(`.square-${m.to}`);
    if (el) el.style.boxShadow =
      m.captured ? "inset 0 0 0 4px red" : "inset 0 0 0 4px rgba(0,0,0,.4)";
  });
}

function onMouseoutSquare() {
  document.querySelectorAll(".square-55d63").forEach(s => s.style.boxShadow = "");
}
</script>

</body>
</html>