<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Шахматы</title>
<style>
body { display:flex; flex-direction:column; align-items:center; background:#111; color:#fff; font-family:sans-serif; margin:0; padding:0; }
#controls { margin:10px; display:flex; align-items:center; gap:10px; }
button, select { font-size:16px; padding:5px; }
#board-container { perspective: 1000px; }
table { border-collapse: collapse; }
td { width:60px; height:60px; text-align:center; vertical-align:middle; font-size:48px; cursor:pointer; transition: background 0.3s; }
.red-sq { background:#800; }
.black-sq { background:#000; }
td.highlight { box-shadow: inset 0 0 10px 5px rgba(255,255,0,0.7); }
.piece { position: relative; top: 0; left: 0; }
.flip { transform: rotate(180deg); }
@media (max-width:600px) {
  td { width:30px; height:30px; font-size:24px; }
}
@media (max-width:400px) {
  td { width:24px; height:24px; font-size:18px; }
}
@keyframes glow {
  0% { box-shadow: 0 0 5px 2px rgba(255,255,0,0.5); }
  100% { box-shadow: 0 0 20px 5px rgba(255,255,0,0); }
}
.check { animation: glow 1s ease-out; }
</style>
</head>
<body>
<div id="controls">
    Уровень:
    <select id="level">
        <option value="1">1 (Новичок)</option>
        <option value="2">2</option>
        <option value="3" selected>3 (Средний)</option>
        <option value="4">4</option>
        <option value="5">5 (Мастер)</option>
    </select>
    Ваш цвет:
    <select id="color">
        <option value="w" selected>Белые</option>
        <option value="b">Чёрные</option>
    </select>
    <button id="newGame">Новая игра</button>
</div>
<div id="board-container"><div id="board"></div></div>
<audio id="moveSound" src="data:audio/wav;base64,UklGRpgiAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YUgiAABiAP9kwb/gfkgBf7eRv80H11zvwz91cMA+Zj5UPk0gejmRPO5Ie0i9qA/jaOZcwBtkfmYF7JFGPNpBH/iIj1GAfqXSvsXqyVm+GGmmFevn6y7ZqJ5ZjqBlv9crsld1LjB3U+vyj8MuWZqWmwrV/gaTolyqxRYsUm8k6bKFktWNvZ3I2dBPZrPAsA7lmY7VAs4ieZ6TCdaJBTL9fMciPe4DhyP+fhKMb+B8XaQcfa0trAs0VLvcL1Xx6870bvqN563Re+HUPkmv3ujHszH4k4/PWo/exPWu3cePz8/IT6cwRd3tTvfcOd6UoN58cHbqi6+WKD8XxLGuo07j3y+u7XfMiJavhd6zLX+vSd4UfsK/qZ1Nn04I/AeVhx4QQ4WfZ1tFyykXDVLyotUavNql9oyGeJ5mVlG+QuYx3iqWDXSYOivkG4nJ1ZMO7yANF8ZhDNo4WdfUTjXGpni+VNKf3eYGtLhzrIX8tjfW3yFDo4sKpr23fyC7aZxW+75+tXdTlsUQ8AuWoJaP+7E/HrhcmvA5q3+dZX7QCdn2N2RKddyzxgeWZ1tfGrB6kxq4XNu5aep4N/eD91LPzJ7/I3vTF/d9+645PTUs2duVhg4ZMGLFdtEmuf+pCUFe5JUHfnbcX1/CcCmO132RGe54KXmHUlq88WcEGBwWH/t6+t5rKJh6n29tqg+0OnbOw6MJQ+2fIqrZtPMUxVmMv2di/aW7Mq+P1RRY2zlHu4brhoT3fc1wnLp36pxn4ce25bhBOm4uuiaEl5ZxQjv7iHMnPOFEaDo+Pnf8fhD93z7wPVnsB0mX6/jwBzL2TsHd4X79Ly4Nm7pTCeyVgkKV1SWv0DX42Pz2qv+wvy82vNu885HedK3mlO46s+qMT1rH3LPGze99xdedwxDby0cl0Oh7ePoAOcf+wPyIrIDkaIx/oDh0I/R9xxDP5Tslo4mZz3n3bHwE=" preload="auto"></audio>
<audio id="captureSound" src="data:audio/wav;base64,UklGRu0BAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YbkBAADEAP9Pyb7/T9uf39+iT9tfvnz5+fj4GLgz9ujv+M32J/IfMhz7KQL3CyQlbK9s1PDvA+IqKP5ZwdIuD1nkDv8vYI+1QFxRPmuA+JB3xJiBhsPkFqKXHM8evnrSyAr7QWsLuH1nPEGf7c+c2rTHsMJdA+0yiPch6P7dB/jH7DrMb4fkcqvyGAtrnqX9aACvqq+kOb+gXGqfqCBEbgz2KXvfrZ9ZujCn6d4guzqT7tbRvTHvuP1LsYslXa3sP0Wh51N3pG+SZz5bPK7ftDd3OyTt9uuPmt9P+oP2nZ/jr+NH98Pe1rvtmfrD/dZ74+0X+yPndUw3eQn7LlXXdfpEh/sfQCpt0Z3UjX0ap0SWvknNrs8Rcp6RtfDzpD3y4R3L2dx/Qk+ue+Kc4nPaXHwAMoOybP86BvXH/pyX7KG/bD5qkT7mNG3789zud85td5PbuIuUl+m+4j69NRbQw+4GqYXth6TTM6Dlrsb96D4V9nZ2ntz+kx9s7O8uHq14jfS0/tTU9nN/XKP+j5j30J/fE8WvmO6s9/0Hzm/6c6ziG6uZdZNQAoyBVmlUfGNy35n/zXCP4=" preload="auto"></audio>
<audio id="checkSound" src="data:audio/wav;base64,UklGRl0AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YW0AAABsAP9Zv8pEfw7Irxh3YMvl5/TCStTzvwvd8P4j5yOlE+2w+Ofw+Ofw+Ofw+PdE+OGj6BDt5P3j4OTy4+F80LHN2jt9uP36HPpc+meWOfTnXOcvvNG4+dybPD76PLx89HBt8ig4fOh4+WeO+4riSiQC1jdNjbc16Etk2sRbtjuXGJb/OTRt8XZCfsDjyo/lfH7tfDj+59rfcv9H0vmj6fd76Y94Hny9P+q9dbnn6W9LX35PmRpd7B3tzeOn0x+134E/qrmpn1EcSDxVZtmP+t9347W3cY/62mFHd7eP25vHL37A+OdE9vP06u34HPX9deHz37D+0L3nH+e0b7sNwPVncBC3+cIXe9eXu8SD3RfXZ0f4H1GWy2OjDlwV/U67xm03/MPO4Zfvp89KfaHXtzzoP1x7jD/3tfWhx1aH97gO1mcG4=" preload="auto"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js"></script>
<script>
// Board representation
let board = [];
let currentColor = 'w';
let selected = null;
let userColor = 'w';
let engine;
const levelDepth = {'1': 1, '2': 3, '3': 5, '4': 7, '5': 10};

// Piece symbols
const symbols = {
  'P':'\u2659','R':'\u2656','N':'\u2658','B':'\u2657','Q':'\u2655','K':'\u2654',
  'p':'\u265F','r':'\u265C','n':'\u265E','b':'\u265D','q':'\u265B','k':'\u265A'
};

// Initialize stockfish
function initEngine() {
    engine = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
    engine.onmessage = function(e) {
        let line = e.data;
        if (line && line.startsWith('bestmove')) {
            const move = line.split(' ')[1];
            makeMove(move, false);
        }
    };
    engine.postMessage('uci');
    engine.postMessage('ucinewgame');
    engine.postMessage('isready');
}

// Initialize board array
function initBoard() {
    board = [
        ['r','n','b','q','k','b','n','r'],
        ['p','p','p','p','p','p','p','p'],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['P','P','P','P','P','P','P','P'],
        ['R','N','B','Q','K','B','N','R']
    ];
    currentColor = 'w';
    selected = null;
}

// Draw board
function drawBoard() {
    const boardDiv = document.getElementById('board');
    boardDiv.innerHTML = '';
    const table = document.createElement('table');
    table.id = 'boardTable';
    if (userColor === 'b') {
        table.classList.add('flip');
    }
    for(let i=0;i<8;i++){
        const tr = document.createElement('tr');
        for(let j=0;j<8;j++){
            const td = document.createElement('td');
            const uiRow = (userColor==='b') ? (7-i) : i;
            const uiCol = (userColor==='b') ? (7-j) : j;
            if ((i+j)%2===0) td.className = 'red-sq'; else td.className = 'black-sq';
            td.id = 'sq-'+i+'-'+j;
            td.onclick = function(){ cellClicked(i,j); };
            const piece = board[i][j];
            if (piece) {
                td.textContent = symbols[piece];
            }
            tr.appendChild(td);
        }
        table.appendChild(tr);
    }
    boardDiv.appendChild(table);
    if (selected) {
        let ui_r = userColor==='b'? 7-selected.r : selected.r;
        let ui_c = userColor==='b'? 7-selected.c : selected.c;
        const td = document.getElementById('sq-'+ui_r+'-'+ui_c);
        if (td) td.classList.add('highlight');
    }
}

// Handle cell click
function cellClicked(r,c) {
    let row = r, col = c;
    if (userColor === 'b') {
        row = 7 - r;
        col = 7 - c;
    }
    const piece = board[row][col];
    if (selected) {
        const from = selected;
        const to = {r:row, c:col};
        if (from.r===to.r && from.c===to.c) {
            selected = null;
            drawBoard();
            return;
        }
        if (piece && isWhite(piece) === (currentColor==='w')) {
            selected = {r:row, c:col};
            drawBoard();
            return;
        }
        if (isLegalMove(from, to) && ((currentColor==='w' && isWhite(board[from.r][from.c]) && userColor==='w') || (currentColor==='b' && !isWhite(board[from.r][from.c]) && userColor==='b'))) {
            let moveStr = coordToAlgebraic(from) + coordToAlgebraic(to);
            makeMove(moveStr, true);
            selected = null;
        }
        drawBoard();
    } else {
        if (piece && ((currentColor==='w' && isWhite(piece) && userColor==='w') || (currentColor==='b' && !isWhite(piece) && userColor==='b'))) {
            selected = {r:row, c:col};
            drawBoard();
        }
    }
}

// Color check
function isWhite(piece) { return piece === piece.toUpperCase(); }

// Algebraic convert
function coordToAlgebraic(coord) {
    const files = 'abcdefgh';
    return files[coord.c] + (8-coord.r);
}

// Check legal (basic)
function isLegalMove(from, to) {
    const dr = to.r - from.r;
    const dc = to.c - from.c;
    const piece = board[from.r][from.c];
    const target = board[to.r][to.c];
    if (target && (isWhite(target) === isWhite(piece))) return false;
    const absdr = Math.abs(dr), absdc = Math.abs(dc);
    let legal = false;
    switch(piece.toLowerCase()) {
        case 'p':
            let dir = isWhite(piece)? -1 : 1;
            if (dc===0 && !target) {
                if (dr===dir) legal=true;
                if ((from.r === (isWhite(piece)?6:1)) && dr===2*dir && !board[from.r+dir][from.c]) legal=true;
            }
            if (absdc===1 && dr===dir && target) legal=true;
            break;
        case 'n':
            if ((absdr===1 && absdc===2) || (absdr===2 && absdc===1)) legal=true;
            break;
        case 'b':
            if (absdr===absdc && clearPath(from,to)) legal=true;
            break;
        case 'r':
            if ((dr===0 || dc===0) && clearPath(from,to)) legal=true;
            break;
        case 'q':
            if ((absdr===absdc || dr===0 || dc===0) && clearPath(from,to)) legal=true;
            break;
        case 'k':
            if (absdr<=1 && absdc<=1) legal=true;
            break;
    }
    return legal;
}

// Clear path for sliding
function clearPath(from, to) {
    const dr = Math.sign(to.r - from.r);
    const dc = Math.sign(to.c - from.c);
    let r = from.r + dr, c = from.c + dc;
    while (r !== to.r || c !== to.c) {
        if (board[r][c]) return false;
        r += dr; c += dc;
    }
    return true;
}

// Execute move
function makeMove(moveStr, isUser) {
    if (moveStr.includes('-')) {
        moveStr = moveStr.split('-')[0] + moveStr.split('-')[1];
    }
    const files = 'abcdefgh';
    const from = {r: 8-parseInt(moveStr[1]), c: files.indexOf(moveStr[0])};
    const to   = {r: 8-parseInt(moveStr[3]), c: files.indexOf(moveStr[2])};
    const piece = board[from.r][from.c];
    const capture = board[to.r][to.c] !== '';
    board[to.r][to.c] = piece;
    board[from.r][from.c] = '';
    if (capture) document.getElementById('captureSound').play();
    else document.getElementById('moveSound').play();
    drawBoard();
    if (isUser) {
        currentColor = (currentColor==='w'?'b':'w');
        const depth = levelDepth[document.getElementById('level').value];
        const fen = boardToFEN();
        engine.postMessage('position fen ' + fen);
        engine.postMessage('go depth ' + depth);
    } else {
        currentColor = (currentColor==='w'?'b':'w');
    }
}

// Board to FEN
function boardToFEN() {
    let fen = '';
    for(let i=0;i<8;i++){
        let empty=0;
        for(let j=0;j<8;j++){
            const piece = board[i][j];
            if (!piece) { empty++; }
            else { if (empty) { fen += empty; empty=0; } fen += piece; }
        }
        if (empty) fen += empty;
        if (i<7) fen += '/';
    }
    fen += ' ' + currentColor + ' - - 0 1';
    return fen;
}

// New Game
document.getElementById('newGame').onclick = function() {
    userColor = document.getElementById('color').value;
    initBoard();
    drawBoard();
    initEngine();
    if (userColor==='b') {
        currentColor = 'w';
        const depth = levelDepth[document.getElementById('level').value];
        const fen = boardToFEN();
        engine.postMessage('position fen ' + fen);
        engine.postMessage('go depth ' + depth);
    }
};
</script>
</body>
</html>