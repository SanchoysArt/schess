<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Hand Draw Precise</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0e0e10;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

#container {
  position: relative;
  width: 100vw;
  height: 100vh;
}

video, canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}

video {
  object-fit: cover;
  transform: scaleX(-1);
}

/* ===== Menu Button ===== */
#menuButton {
  position: absolute;
  top: 16px;
  left: 16px;
  padding: 10px 14px;
  border-radius: 14px;
  background: rgba(255,255,255,0.14);
  backdrop-filter: blur(12px);
  color: white;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s;
}
#menuButton:hover {
  background: rgba(255,255,255,0.22);
}

/* ===== Menu ===== */
#menu {
  position: absolute;
  top: 64px;
  left: 16px;
  padding: 16px;
  border-radius: 18px;
  background: rgba(255,255,255,0.14);
  backdrop-filter: blur(14px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  color: white;
  min-width: 200px;
  opacity: 0;
  transform: translateY(-10px);
  pointer-events: none;
  transition: 0.3s ease;
}
#menu.open {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.menu-group {
  margin-bottom: 12px;
}
label {
  font-size: 12px;
  opacity: 0.8;
}
input {
  width: 100%;
  margin-top: 6px;
}
</style>
</head>

<body>
<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <div id="menuButton">⚙️ Меню</div>

  <div id="menu">
    <div class="menu-group">
      <label>Цвет</label>
      <input type="color" id="color" value="#ffffff">
    </div>
    <div class="menu-group">
      <label>Толщина</label>
      <input type="range" id="thickness" min="2" max="20" value="6">
    </div>
  </div>
</div>

<script>
/* ===== Setup ===== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const menuButton = document.getElementById('menuButton');
const menu = document.getElementById('menu');
const colorInput = document.getElementById('color');
const thicknessInput = document.getElementById('thickness');

let drawColor = colorInput.value;
let drawThickness = thicknessInput.value;

let drawing = false;
let lastPoint = null;
let smoothPoint = null;

const PINCH_DISTANCE = 0.035; // ЖЁСТКИЙ порог соприкосновения
const SMOOTHING = 0.25;

/* ===== Resize ===== */
function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener('resize', resize);
resize();

/* ===== Utils ===== */
function lerp(a, b, t) {
  return a + (b - a) * t;
}

function dist(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

function toScreen(p) {
  return {
    x: (1 - p.x) * canvas.width,
    y: p.y * canvas.height
  };
}

/* ===== MediaPipe ===== */
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.8,
  minTrackingConfidence: 0.8
});

hands.onResults(onResults);

const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 1280,
  height: 720
});
camera.start();

/* ===== Main ===== */
function onResults(res) {
  if (!res.multiHandLandmarks?.length) {
    drawing = false;
    lastPoint = null;
    smoothPoint = null;
    return;
  }

  const lm = res.multiHandLandmarks[0];
  const thumb = lm[4];
  const index = lm[8];

  const d = dist(thumb, index);
  const pinch = d < PINCH_DISTANCE;

  const a = toScreen(thumb);
  const b = toScreen(index);
  const mid = { x: (a.x + b.x)/2, y: (a.y + b.y)/2 };

  // сглаживание
  if (!smoothPoint) smoothPoint = mid;
  smoothPoint.x = lerp(smoothPoint.x, mid.x, SMOOTHING);
  smoothPoint.y = lerp(smoothPoint.y, mid.y, SMOOTHING);

  // визуальные палочки
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGlassLine(a, b);
  drawDot(smoothPoint);

  // рисование ТОЛЬКО при соприкосновении
  if (pinch) {
    if (lastPoint) {
      ctx.strokeStyle = drawColor;
      ctx.lineWidth = drawThickness;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(lastPoint.x, lastPoint.y);
      ctx.lineTo(smoothPoint.x, smoothPoint.y);
      ctx.stroke();
    }
    lastPoint = { ...smoothPoint };
  } else {
    lastPoint = null;
  }
}

/* ===== Visuals ===== */
function drawGlassLine(a, b) {
  const m = { x:(a.x+b.x)/2, y:(a.y+b.y)/2 };
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth = 8;
  ctx.lineCap = 'round';

  ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(m.x,m.y); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(m.x,m.y); ctx.stroke();
}

function drawDot(p) {
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.beginPath();
  ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
  ctx.fill();
}

/* ===== UI ===== */
menuButton.onclick = () => menu.classList.toggle('open');
colorInput.oninput = e => drawColor = e.target.value;
thicknessInput.oninput = e => drawThickness = e.target.value;
</script>
</body>
</html>